name: Tetris Smart Contract CI

on:
  push:
    branches: [main, master, develop]
    paths:
      - 'examples/tetris/**'
      - '.github/workflows/tetris.yml'
  pull_request:
    branches: [main, master, develop]
    paths:
      - 'examples/tetris/**'

env:
  CARGO_TERM_COLOR: always
  RUST_VERSION: stable

jobs:
  check:
    name: Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: rustfmt, clippy
          cache: true
      
      - name: Check formatting
        run: cargo fmt --all -- --check
        working-directory: examples/tetris
      
      - name: Run Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings
        working-directory: examples/tetris
      
      - name: Check code
        run: cargo check --all-features
        working-directory: examples/tetris

  test:
    name: Test Suite
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}
          cache: true
      
      - name: Run tests
        run: cargo test --all-features --verbose
        working-directory: examples/tetris
      
      - name: Generate test coverage
        run: cargo test --all-features --no-fail-fast
        working-directory: examples/tetris

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}
          cache: true
      
      - name: Build debug
        run: cargo build --verbose
        working-directory: examples/tetris
      
      - name: Build release
        run: cargo build --release --verbose
        working-directory: examples/tetris

  build-wasm:
    name: Build WASM for Soroban
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}
          target: wasm32-unknown-unknown
          cache: true
      
      - name: Install Stellar CLI
        run: |
          cargo install --locked stellar-cli || true
          stellar --version || echo "Stellar CLI installation in progress..."
      
      - name: Build WASM with Stellar CLI
        run: stellar contract build || cargo build --target wasm32-unknown-unknown --release
        working-directory: examples/tetris
      
      - name: Verify WASM artifact
        run: |
          if [ -f "target/wasm32-unknown-unknown/release/tetris.wasm" ]; then
            ls -lh target/wasm32-unknown-unknown/release/tetris.wasm
            echo "✅ WASM build successful"
          else
            echo "❌ WASM file not found"
            exit 1
          fi
        working-directory: examples/tetris
      
      - name: Upload WASM artifact
        uses: actions/upload-artifact@v4
        with:
          name: tetris-wasm
          path: examples/tetris/target/wasm32-unknown-unknown/release/tetris.wasm
          retention-days: 7

  all-checks:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [check, test, build, build-wasm]
    steps:
      - name: Confirm success
        run: echo "✅ All checks passed successfully!"
